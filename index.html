<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CarNote Online | ‡∏ï‡∏•‡∏≤‡∏î‡∏£‡∏ñ‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;600;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pM2bQf2H5Q2t3g9w5h8z0Yv1Wq3rZ68e7b0J8zDq8Qx7Xj8v1q6Zl0V6f5y3Xk6s9y1Q6v2K2Q9f3G4v2y1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Firebase (kept as in original) -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

  <!-- ====== Enhanced styles (modern, responsive, animations) ====== -->
  <style>
    /* ---------- Design tokens ---------- */
    :root{
      --bg-1: #071021;
      --bg-2: #0b1220;
      --surface: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.06);
      --glass-2: rgba(255,255,255,0.04);
      --glass-border: rgba(255,255,255,0.06);
      --accent-start: #ff7a18;
      --accent-end: #fb2e86;
      --accent: linear-gradient(135deg,var(--accent-start),var(--accent-end));
      --accent-solid: #fb8c00;
      --muted: rgba(255,255,255,0.72);
      --text-dark: #eaf4ff;
      --text-light: #eaf4ff;
      --success: #10b981;
      --danger: #ef4444;
      --radius-lg: 18px;
      --radius-md: 12px;
      --card-shadow: 0 12px 32px rgba(2,6,23,0.6);
      --glass-blur: 10px;
      --max-width: 1100px;
      --ui-gap: 18px;
    }

    /* Light theme overrides */
    :root[data-theme="light"]{
      --bg-1: #f6fbff;
      --bg-2: #eef6ff;
      --surface: rgba(10,14,23,0.03);
      --glass: rgba(10,14,23,0.03);
      --glass-border: rgba(10,14,23,0.06);
      --muted: rgba(15,23,42,0.6);
      --text-dark: #0f172a;
      --text-light: #0f172a;
      --card-shadow: 0 12px 36px rgba(12,18,36,0.06);
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.001ms !important; transition-duration: 0.001ms !important; }
    }

    /* ---------- Page baseline ---------- */
    html,body{
      height:100%;
      margin:0;
      font-family: "Inter", "Anuphan", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: var(--text-dark);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(251,140,0,0.06), transparent 6%),
        radial-gradient(900px 500px at 90% 80%, rgba(251,46,134,0.04), transparent 8%),
        linear-gradient(180deg,var(--bg-1), var(--bg-2));
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color: transparent;
      transition: background .4s ease, color .3s ease;
    }

    /* Page background layer for subtle floating band & particles */
    .page-bg{
      position:fixed; inset:0; z-index:-2; pointer-events:none;
      overflow:hidden;
    }
    .bg-band{
      position:absolute; left:-20%; right:-20%; top:-30%; height:140%;
      background: linear-gradient(90deg, rgba(255,122,24,0.10), rgba(251,46,134,0.08));
      filter: blur(48px);
      transform: rotate(8deg);
      animation: slow-pan 18s linear infinite;
    }
    @keyframes slow-pan { 0%{transform:rotate(8deg) translateX(-2%)} 50%{transform:rotate(6deg) translateX(2%)} 100%{transform:rotate(8deg) translateX(-2%)} }

    /* subtle glass container */
    .shell{
      max-width: var(--max-width);
      margin: 28px auto;
      padding: 20px;
      box-sizing:border-box;
    }

    /* ---------- Header ---------- */
    nav{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 14px 20px;
      border-radius: 14px;
      margin: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-border);
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      backdrop-filter: blur(var(--glass-blur));
      position: sticky; top: 12px; z-index: 999;
      transition: transform .28s ease, box-shadow .28s ease;
    }
    nav:hover{ transform: translateY(-2px); }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .brand .logo-mark{
      width:52px; height:52px; border-radius:12px;
      background: linear-gradient(135deg,var(--accent-start),var(--accent-end));
      display:inline-grid; place-items:center; color:white; font-weight:800;
      box-shadow: 0 8px 30px rgba(251,46,134,0.12), inset 0 -6px 12px rgba(0,0,0,0.12);
      font-family: "Anuphan", "Inter", sans-serif;
    }
    .brand h1{
      margin:0; font-size:1.05rem; letter-spacing:-0.02em; color:var(--text-dark);
    }
    .nav-actions{ display:flex; gap:10px; align-items:center; }

    .admin-btn{
      padding:10px 14px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.04);
      color:var(--muted); font-weight:600; cursor:pointer; display:inline-flex; gap:8px; align-items:center;
      transition: transform .18s ease, background .18s ease;
    }
    .admin-btn:hover{ transform: translateY(-4px); background: linear-gradient(90deg, rgba(255,255,255,0.02), transparent); }

    .theme-toggle{
      width:44px; height:44px; border-radius:10px; display:grid; place-items:center;
      cursor:pointer; border:1px solid rgba(255,255,255,0.04); background:transparent;
    }

    /* ---------- Hero ---------- */
    .hero-banner{
      margin: 18px 10px;
      border-radius: 18px;
      overflow:hidden;
      display:flex; gap:18px; align-items:center; padding:18px;
      background: linear-gradient(135deg, rgba(255,122,24,0.12), rgba(251,46,134,0.09));
      border: 1px solid rgba(255,255,255,0.03); box-shadow: 0 12px 36px rgba(2,6,23,0.22);
      backdrop-filter: blur(6px);
    }
    .hero-content{ flex:1; color:var(--text-dark); }
    .hero-title{ margin:0; font-size: clamp(1.25rem, 2.4vw, 1.8rem); font-weight:800; letter-spacing:-0.02em; }
    .hero-sub{ margin:6px 0 0 0; font-size:0.95rem; color:var(--muted); }

    .hero-visual{
      width:120px; height:120px; border-radius:14px; overflow:hidden; flex-shrink:0;
      border: 1px solid rgba(255,255,255,0.04);
      display:grid; place-items:center; background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    }
    .hero-visual img{ width:90px; height:90px; object-fit:cover; border-radius:12px; }

    /* ---------- Container & Admin Panel ---------- */
    .container{
      margin: 18px 10px;
      display:grid; gap:var(--ui-gap);
      grid-template-columns: 1fr 420px;
      align-items:start;
    }
    @media (max-width:1100px){ .container{ grid-template-columns: 1fr; } }

    #adminPanel{
      position:sticky; top:84px;
      border-radius:16px;
      padding:18px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-border);
      box-shadow: 0 12px 30px rgba(2,6,23,0.18);
      backdrop-filter: blur(var(--glass-blur));
      display:none; /* toggled by admin login */
    }
    #adminPanel.show{ display:block; animation: slideFadeIn .48s cubic-bezier(.2,.9,.25,1); }
    @keyframes slideFadeIn { from{ opacity:0; transform:translateY(12px) } to{ opacity:1; transform:translateY(0) } }

    label, input, select, textarea, button { font-family: inherit; }

    input[type="text"], input[type="password"], input[type="file"], select, textarea{
      width:100%; padding:12px 14px; border-radius:12px; font-size:0.95rem;
      border:1px solid rgba(255,255,255,0.04); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      color:var(--text-dark); box-sizing:border-box; outline:none;
      transition: box-shadow .14s ease, transform .12s ease;
    }
    input:focus, select:focus, textarea:focus{ box-shadow: 0 10px 28px rgba(124,58,237,0.08); transform: translateY(-2px); }

    .file-label{
      display:block; padding:12px; border-radius:12px; text-align:center; cursor:pointer;
      border:2px dashed rgba(255,255,255,0.04); color:var(--muted); background:transparent;
    }

    .btn-post{
      display:inline-flex; gap:10px; align-items:center; justify-content:center;
      width:100%; padding:12px 14px; border-radius:12px; color:white; font-weight:700; border:none;
      background: linear-gradient(90deg,var(--accent-start),var(--accent-end));
      box-shadow: 0 12px 34px rgba(251,46,134,0.12);
      cursor:pointer; transition: transform .18s cubic-bezier(.2,.9,.25,1), filter .18s;
    }
    .btn-post:active{ transform: translateY(1px) scale(.998); }
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:10px 12px; border-radius:12px; cursor:pointer; }

    /* ---------- Car list / cards ---------- */
    #carList{ display:grid; gap:18px; }
    .car-card{
      border-radius:16px; overflow:hidden; position:relative;
      border: 1px solid rgba(255,255,255,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      box-shadow: var(--card-shadow);
      display:flex; flex-direction:column;
      transition: transform .28s cubic-bezier(.2,.9,.25,1), box-shadow .28s;
      will-change: transform;
    }
    .car-card:hover{ transform: translateY(-6px); box-shadow: 0 26px 60px rgba(2,6,23,0.24); }

    .car-top{
      position:relative; min-height:260px; background:#111;
    }
    .car-img{ width:100%; height:100%; object-fit:cover; display:block; min-height:260px; }

    .status-tag{
      position:absolute; top:16px; left:16px; padding:8px 12px; border-radius:999px; color:white; font-weight:800;
      font-size:0.78rem; text-transform:uppercase; letter-spacing:0.04em; box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
      display:inline-flex; gap:8px; align-items:center;
    }
    .tag-available{ background: linear-gradient(90deg,#10b981,#06b6d4); }
    .tag-sold{ background: linear-gradient(90deg,#ef4444,#fb7185); }

    .details{ padding: 18px; display:flex; flex-direction:column; gap:8px; }
    .details h2{ margin:0; font-size:1.05rem; display:flex; align-items:center; gap:10px; }
    .price{ margin-top:2px; font-size:1.32rem; font-weight:800; color:var(--accent-start); }

    .contact-area{ display:flex; gap:10px; margin-top:8px; }
    .btn-contact{
      flex:1; padding:10px 12px; border-radius:12px; display:inline-flex; gap:8px; align-items:center; justify-content:center;
      color:white; text-decoration:none; font-weight:700; box-shadow: 0 8px 26px rgba(0,0,0,0.12);
      transition: transform .16s ease, box-shadow .16s ease;
    }
    .btn-contact:hover{ transform: translateY(-3px); box-shadow: 0 18px 40px rgba(0,0,0,0.18); }
    .btn-facebook{ background: linear-gradient(90deg,#1877F2,#166FE5); }
    .btn-phone{ background: linear-gradient(90deg,#0f172a,#394b6b); }

    .admin-controls{ display:flex; gap:10px; margin-top:12px; }
    .btn-edit{ flex:1; padding:10px; background: linear-gradient(90deg,#fef3c7,#fde68a); border-radius:10px; color:#92400e; font-weight:800; border:none; cursor:pointer; }
    .btn-del{ flex:1; padding:10px; background: linear-gradient(90deg,#fee2e2,#fecaca); border-radius:10px; color:#991b1b; font-weight:800; border:none; cursor:pointer; }

    .comment-section{ padding:14px 18px; border-top:1px solid rgba(255,255,255,0.02); background: linear-gradient(180deg, rgba(255,255,255,0.00), transparent); }
    .comment-item{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); margin-bottom:8px; position:relative; font-size:0.9rem; color:var(--muted); }

    .btn-del-cmt{ position:absolute; right:8px; top:8px; background:transparent; border:none; color:var(--danger); cursor:pointer; }

    /* ---------- Overlays & modals ---------- */
    .overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.6));
      backdrop-filter: blur(8px); z-index:3000; padding:18px;
    }
    .welcome-card{
      width:100%; max-width:420px; border-radius:16px; padding:22px; text-align:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-border);
      box-shadow: 0 28px 80px rgba(2,6,23,0.7);
      animation: popIn .36s cubic-bezier(.2,.9,.25,1);
    }
    @keyframes popIn{ from{ opacity:0; transform:translateY(10px) scale(.98) } to{ opacity:1; transform:none } }
    .loader{
      width:56px; height:56px; border-radius:50%;
      border:6px solid rgba(255,255,255,0.06); border-left-color: transparent; border-right-color: transparent;
      border-bottom-color: var(--accent-start); margin: 10px auto 8px auto; animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg) } }

    /* ---------- Utility / animations ---------- */
    .reveal { opacity:0; transform: translateY(10px) scale(.995); transition: opacity .6s cubic-bezier(.2,.9,.25,1), transform .6s cubic-bezier(.2,.9,.25,1); }
    .reveal.visible{ opacity:1; transform:none; }

    .small{ font-size:0.86rem; color:var(--muted); }

    /* ---------- Responsive tweaks ---------- */
    @media (max-width:720px){
      .hero-visual{ display:none; }
      nav{ padding:12px; margin:8px; }
      .shell{ padding:12px; }
      .hero-banner{ flex-direction:column; align-items:flex-start; gap:10px; padding:14px; }
      #adminPanel{ position:static; top:auto; }
      .container{ gap:12px; }
      .car-top{ min-height:180px; }
    }

  </style>
</head>
<body>

  <div class="page-bg" aria-hidden="true">
    <div class="bg-band" aria-hidden="true"></div>
    <canvas id="particles" class="particles" style="position:absolute; inset:0; width:100%; height:100%;"></canvas>
  </div>

  <div class="shell">
    <!-- Header -->
    <nav>
      <div class="brand">
        <div class="logo-mark" aria-hidden="true">CN</div>
        <div>
          <h1>CarNote Online</h1>
          <div class="small">‡∏ï‡∏•‡∏≤‡∏î‡∏£‡∏ñ‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</div>
        </div>
      </div>

      <div class="nav-actions">
        <button id="themeToggle" class="theme-toggle" title="Toggle theme" aria-label="Toggle theme">
          <i id="themeIcon" class="fa-regular fa-moon"></i>
        </button>
        <button id="adminBtn" class="admin-btn" onclick="handleAdmin()" title="Admin access">‚öôÔ∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
      </div>
    </nav>

    <!-- Hero -->
    <section class="hero-banner reveal" aria-labelledby="heroTitle">
      <div class="hero-content">
        <h2 id="heroTitle" class="hero-title">CarNote Online</h2>
        <p class="hero-sub">Premium Quality Second Hand Cars üß° ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à</p>
      </div>
      <div class="hero-visual" aria-hidden="true">
        <img src="Icon.png" alt="CarNote Logo">
      </div>
    </section>

    <!-- Main content grid -->
    <main class="container">
      <!-- Left: car list -->
      <div id="carList" class="reveal" aria-live="polite"></div>

      <!-- Right: admin panel (hidden until admin login) -->
      <aside id="adminPanel" class="reveal" aria-hidden="true">
        <h4 id="panelTitle" style="margin:0 0 12px 0;">‚ú® ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà</h4>
        <input type="text" id="carTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô / ‡∏õ‡∏µ" />
        <input type="text" id="carPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)" />
        <label for="carFile" id="fileLabel" class="file-label">üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏£‡∏ñ</label>
        <input type="file" id="carFile" accept="image/*" style="display:none" />
        <select id="carStatus">
          <option value="available">üü¢ ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢)</option>
          <option value="sold">üî¥ ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢)</option>
        </select>
        <button id="uploadBtn" class="btn-post" onclick="startUpload()">‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
        <button id="cancelEditBtn" class="btn-ghost" onclick="cancelEdit()" style="display:none; margin-top:8px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </aside>
    </main>
  </div>

  <!-- Loading & overlays (kept IDs and behavior) -->
  <div id="loadingOverlay" class="overlay" style="display:none; opacity:0; transition:opacity .18s;">
    <div class="welcome-card" style="max-width:220px;">
      <div class="loader" role="status" aria-hidden="true"></div>
      <h4 style="margin:0; color:var(--accent-start);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</h4>
    </div>
  </div>

  <div id="welcomePopup" class="overlay" aria-modal="true">
    <div class="welcome-card">
      <img src="Icon.png" style="width:110px; height:110px; border-radius:16px; margin-bottom:12px; object-fit:cover;" alt="Icon">
      <h3 style="margin:0; font-weight:800;">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà <span style="background:var(--accent); -webkit-background-clip:text; background-clip:text; color:transparent;">CarNote Online</span></h3>
      <p style="color:var(--muted); margin:10px 0 18px;">Premium Quality Second Hand Cars üß°</p>
      <button id="welcomeStart" class="btn-post" onclick="closeWelcome()" aria-label="Start">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
    </div>
  </div>

  <div id="adminModal" class="overlay" style="display:none; opacity:0;">
    <div class="welcome-card" style="border-top:6px solid var(--accent-start);">
      <h3 style="margin:0; font-weight:800;">üîê ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¥‡∏ô</h3>
      <input type="password" id="adminPassInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•" style="text-align:center; letter-spacing:5px; margin-top:18px;" />
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button onclick="closeAdminModal()" class="btn-ghost" style="flex:1;">‡∏õ‡∏¥‡∏î</button>
        <button onclick="checkAdminPass()" class="btn-post" style="flex:2;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
  </div>

  <!-- ===== Application script (preserves original IDs & behavior) ===== -->
  <script>
    /* -------------------------
       Configuration (kept from original)
       ------------------------- */
    const firebaseConfig = {
        apiKey: "AIzaSyANA3-UyKf-MS2dcmbAuPGt-KtRd0KTmGw",
        authDomain: "note-communitycar.firebaseapp.com",
        databaseURL: "https://note-communitycar-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "note-communitycar",
        storageBucket: "note-communitycar.appspot.com",
        messagingSenderId: "387457886547",
        appId: "1:387457886547:web:d7e5f60fb7d2cdbf3ed9a6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const IMGBB_API_KEY = '5a3de96d3f6deddc05d65dc1928e466b';

    /* -------------------------
       App state
       ------------------------- */
    let isAdmin = false, editMode = false, editKey = null, existingImgUrl = null;

    /* -------------------------
       Helpers: UI toggles
       ------------------------- */
    function showLoading() {
      const el = document.getElementById('loadingOverlay');
      el.style.display = 'flex';
      requestAnimationFrame(()=> el.style.opacity = '1');
    }
    function hideLoading() {
      const el = document.getElementById('loadingOverlay');
      el.style.opacity = '0';
      setTimeout(()=> el.style.display = 'none', 240);
    }

    function closeWelcome() {
        const w = document.getElementById('welcomePopup');
        w.style.transition = 'opacity .25s ease, transform .25s ease';
        w.style.opacity = '0';
        w.style.transform = 'scale(.98)';
        setTimeout(()=> w.style.display = 'none', 280);
    }

    function handleAdmin() {
        if (!isAdmin) {
            const modal = document.getElementById('adminModal');
            modal.style.display = 'flex';
            setTimeout(()=> { modal.style.opacity = '1'; }, 20);
        }
        else {
            isAdmin = false;
            document.getElementById('adminPanel').classList.remove('show');
            document.getElementById('adminBtn').innerText = "‚öôÔ∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô";
            renderCars(); // re-render to hide admin controls
        }
    }

    function closeAdminModal() {
        const modal = document.getElementById('adminModal');
        modal.style.opacity = '0';
        setTimeout(()=> modal.style.display = 'none', 240);
    }

    function checkAdminPass() {
        if (document.getElementById('adminPassInput').value === "Note#2026!Car@Phupha99") {
            isAdmin = true;
            document.getElementById('adminPanel').classList.add('show');
            document.getElementById('adminBtn').innerText = "üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô";
            closeAdminModal();
            renderCars();
            // nice micro-interaction
            document.getElementById('carTitle').focus();
        } else { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!"); }
    }

    function cancelEdit(){
      editMode = false; editKey = null; existingImgUrl = null;
      document.getElementById('carTitle').value = '';
      document.getElementById('carPrice').value = '';
      document.getElementById('carStatus').value = 'available';
      document.getElementById('fileLabel').innerText = 'üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏£‡∏ñ';
      document.getElementById('cancelEditBtn').style.display = 'none';
    }

    /* -------------------------
       Upload / Create / Update car
       ------------------------- */
    async function startUpload(){
      const title = document.getElementById('carTitle').value.trim();
      const price = document.getElementById('carPrice').value.trim();
      const fileInput = document.getElementById('carFile');
      const file = fileInput.files && fileInput.files[0];
      const status = document.getElementById('carStatus').value;

      if(!title || !price){
        return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
      }

      try {
        showLoading();

        let imageUrl = existingImgUrl || '';
        // If a file selected, upload to imgbb
        if(file){
          const form = new FormData();
          form.append('image', file);
          // imgbb expects base64 or multipart/form-data; sending as multipart works
          const resp = await fetch('https://api.imgbb.com/1/upload?key=' + IMGBB_API_KEY, {
            method: 'POST',
            body: form
          });
          const json = await resp.json();
          if(!json.success) {
            throw new Error('Image upload failed');
          }
          imageUrl = json.data.url;
        }

        const payload = {
          title,
          price,
          img: imageUrl,
          status,
          createdAt: Date.now()
        };

        if(editMode && editKey){
          await db.ref('cars/' + editKey).update(payload);
        } else {
          await db.ref('cars').push(payload);
        }

        // reset form & UI
        cancelEdit();
        fileInput.value = '';
        hideLoading();
      } catch (err) {
        hideLoading();
        console.error(err);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ'));
      }
    }

    /* -------------------------
       Render cars from Firebase
       ------------------------- */
    function formatPrice(p){
      try{
        const n = Number(p.toString().replace(/[^0-9.-]+/g,''));
        return n.toLocaleString('th-TH') + ' ‡∏ø';
      }catch(e){ return p + ' ‡∏ø'; }
    }

    function renderCars(){
      const root = document.getElementById('carList');
      root.innerHTML = '';
      // read once and listen for updates
      db.ref('cars').orderByChild('createdAt').on('value', snapshot => {
        const data = snapshot.val() || {};
        // convert to array of entries in descending order
        const entries = Object.entries(data).map(([k,v]) => ({ key:k, ...v })).sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
        root.innerHTML = '';
        if(entries.length === 0){
          const empty = document.createElement('div');
          empty.className = 'car-card';
          empty.style.padding = '30px';
          empty.style.textAlign = 'center';
          empty.innerHTML = `<div style="font-weight:800; font-size:1.05rem; margin-bottom:8px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</div><div class="small">‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏£‡∏ñ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</div>`;
          root.appendChild(empty);
        }

        for(const ent of entries){
          const card = document.createElement('article');
          card.className = 'car-card reveal';

          // Top image area
          const top = document.createElement('div');
          top.className = 'car-top';
          const img = document.createElement('img');
          img.className = 'car-img';
          img.alt = ent.title || 'car image';
          img.src = ent.img || 'https://via.placeholder.com/1200x600?text=No+Image';
          top.appendChild(img);

          // status tag
          const tag = document.createElement('div');
          tag.className = 'status-tag ' + (ent.status === 'sold' ? 'tag-sold' : 'tag-available');
          tag.innerHTML = `${ent.status === 'sold' ? '<i class="fa-solid fa-xmark"></i>' : '<i class="fa-solid fa-check"></i>'} ${ent.status === 'sold' ? '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢'}`;
          top.appendChild(tag);

          // Details
          const det = document.createElement('div');
          det.className = 'details';
          const h2 = document.createElement('h2');
          h2.innerHTML = `<span>${ent.title || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>`;
          det.appendChild(h2);
          const price = document.createElement('div');
          price.className = 'price';
          price.textContent = formatPrice(ent.price || '');
          det.appendChild(price);

          // Contact area (sample)
          const contacts = document.createElement('div');
          contacts.className = 'contact-area';
          const fb = document.createElement('a');
          fb.className = 'btn-contact btn-facebook';
          fb.href = '#';
          fb.innerHTML = `<i class="fa-brands fa-facebook-f"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô Facebook`;
          const tel = document.createElement('a');
          tel.className = 'btn-contact btn-phone';
          tel.href = 'tel:+66000000000';
          tel.innerHTML = `<i class="fa-solid fa-phone"></i> ‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á`;
          contacts.appendChild(fb);
          contacts.appendChild(tel);
          det.appendChild(contacts);

          // Admin controls
          if(isAdmin){
            const ac = document.createElement('div');
            ac.className = 'admin-controls';
            const editBtn = document.createElement('button');
            editBtn.className = 'btn-edit';
            editBtn.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            editBtn.onclick = ()=> enterEditMode(ent.key, ent);
            const delBtn = document.createElement('button');
            delBtn.className = 'btn-del';
            delBtn.textContent = '‡∏•‡∏ö';
            delBtn.onclick = ()=> removeCar(ent.key);
            ac.appendChild(editBtn);
            ac.appendChild(delBtn);
            det.appendChild(ac);
          }

          // Comments / simple comment form
          const commentWrap = document.createElement('div');
          commentWrap.className = 'comment-section';
          const commentList = document.createElement('div');
          commentList.id = 'comments-' + ent.key;
          commentList.style.marginBottom = '8px';
          commentWrap.appendChild(commentList);

          const commentForm = document.createElement('div');
          commentForm.style.display = 'flex';
          commentForm.style.gap = '8px';
          const commentInput = document.createElement('input');
          commentInput.type = 'text';
          commentInput.placeholder = '‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô...';
          commentInput.style.flex = '1';
          commentInput.style.padding = '10px';
          commentInput.style.borderRadius = '10px';
          const commentBtn = document.createElement('button');
          commentBtn.className = 'btn-post';
          commentBtn.style.flex = '0 0 140px';
          commentBtn.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå';
          commentBtn.onclick = ()=> addComment(ent.key, commentInput.value, commentInput, commentList);
          commentForm.appendChild(commentInput);
          commentForm.appendChild(commentBtn);
          commentWrap.appendChild(commentForm);

          // assemble card
          card.appendChild(top);
          card.appendChild(det);
          card.appendChild(commentWrap);
          root.appendChild(card);
        }

        // reveal animations for newly inserted items
        requestAnimationFrame(()=> {
          document.querySelectorAll('.reveal').forEach(el=> el.classList.add('visible'));
        });
      });
    }

    async function removeCar(key){
      if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      try{
        await db.ref('cars/' + key).remove();
        // feedback
      }catch(e){ console.error(e); alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
    }

    function enterEditMode(key, data){
      editMode = true;
      editKey = key;
      existingImgUrl = data.img || '';
      document.getElementById('carTitle').value = data.title || '';
      document.getElementById('carPrice').value = data.price || '';
      document.getElementById('carStatus').value = data.status || 'available';
      document.getElementById('fileLabel').innerText = existingImgUrl ? 'üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß' : 'üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏£‡∏ñ';
      document.getElementById('cancelEditBtn').style.display = 'block';
      // reveal admin panel if hidden
      document.getElementById('adminPanel').classList.add('show');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /* -------------------------
       Simple comment system per car (stored under cars/{key}/comments)
       ------------------------- */
    function addComment(carKey, text, inputEl, listEl){
      const value = (text || '').trim();
      if(!value) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå');
      const c = {
        text: value,
        createdAt: Date.now()
      };
      db.ref('cars/' + carKey + '/comments').push(c).then(()=> {
        inputEl.value = '';
      }).catch(e=> {
        console.error(e);
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÑ‡∏î‡πâ');
      });
    }
    // listen and render comments
    function watchComments(){
      db.ref('cars').on('value', snapshot => {
        const cars = snapshot.val() || {};
        Object.entries(cars).forEach(([k,v])=>{
          const container = document.getElementById('comments-' + k);
          if(!container) return;
          container.innerHTML = '';
          if(!v.comments) return;
          const comments = Object.entries(v.comments).map(([ck,cv])=> ({ key:ck, ...cv})).sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
          comments.forEach(c => {
            const itm = document.createElement('div');
            itm.className = 'comment-item';
            itm.textContent = c.text;
            // delete comment button for admin
            if(isAdmin){
              const del = document.createElement('button');
              del.className = 'btn-del-cmt';
              del.innerHTML = '<i class="fa-solid fa-trash"></i>';
              del.onclick = ()=> {
                if(confirm('‡∏•‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                  db.ref('cars/' + k + '/comments/' + c.key).remove();
                }
              };
              itm.appendChild(del);
            }
            container.appendChild(itm);
          });
        });
      });
    }

    /* -------------------------
       Theme toggle
       ------------------------- */
    const themeBtn = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    function applyTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      if(theme === 'light'){
        themeIcon.className = 'fa-regular fa-sun';
      } else {
        themeIcon.className = 'fa-regular fa-moon';
      }
      localStorage.setItem('cn-theme', theme);
    }
    themeBtn.addEventListener('click', ()=> {
      const cur = localStorage.getItem('cn-theme') || 'dark';
      const next = cur === 'dark' ? 'light' : 'dark';
      applyTheme(next);
    });
    // init theme
    (function(){
      const saved = localStorage.getItem('cn-theme');
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      applyTheme(saved || (prefersLight ? 'light' : 'dark'));
    })();

    /* -------------------------
       Particles background (lightweight)
       ------------------------- */
    (function(){
      const canvas = document.getElementById('particles');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      let w = canvas.width = canvas.offsetWidth;
      let h = canvas.height = canvas.offsetHeight;
      const particles = [];
      const count = Math.max(20, Math.round((w*h)/90000));

      function rand(min,max){ return Math.random()*(max-min)+min; }
      function create(){
        for(let i=0;i<count;i++){
          particles.push({
            x: rand(0,w),
            y: rand(0,h),
            r: rand(0.6,2.6),
            vx: rand(-0.2,0.6),
            vy: rand(-0.15,0.15),
            hue: rand(0,360),
            alpha: rand(0.05,0.18)
          });
        }
      }
      function resize(){
        w = canvas.width = canvas.offsetWidth;
        h = canvas.height = canvas.offsetHeight;
        particles.length = 0;
        create();
      }
      function draw(){
        ctx.clearRect(0,0,w,h);
        for(const p of particles){
          p.x += p.vx;
          p.y += p.vy;
          if(p.x > w + 20) p.x = -20;
          if(p.x < -20) p.x = w + 20;
          if(p.y > h + 20) p.y = -20;
          if(p.y < -20) p.y = h + 20;
          ctx.beginPath();
          ctx.fillStyle = `hsla(${p.hue}, 80%, 65%, ${p.alpha})`;
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
          ctx.fill();
        }
        requestAnimationFrame(draw);
      }

      create();
      draw();
      window.addEventListener('resize', () => { clearTimeout(window._pt); window._pt = setTimeout(resize, 240); });
    })();

    /* -------------------------
       Reveal animations (intersection observer)
       ------------------------- */
    (function(){
      const io = new IntersectionObserver((entries) => {
        entries.forEach(e => {
          if(e.isIntersecting) {
            e.target.classList.add('visible');
            // optionally unobserve to improve perf
            io.unobserve(e.target);
          }
        });
      }, { threshold: 0.08 });
      document.querySelectorAll('.reveal').forEach(el => io.observe(el));
    })();

    /* -------------------------
       Wire up small UX details
       ------------------------- */
    // label -> file input
    document.getElementById('fileLabel').addEventListener('click', ()=> {
      document.getElementById('carFile').click();
    });
    document.getElementById('carFile').addEventListener('change', function(){
      if(this.files && this.files[0]) {
        document.getElementById('fileLabel').innerText = 'üì∏ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß: ' + this.files[0].name;
      } else {
        document.getElementById('fileLabel').innerText = 'üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏£‡∏ñ';
      }
    });

    // when content starts, render cars and comments
    renderCars();
    watchComments();

    // ensure welcome popup closes after a short delay (or user clicks)
    setTimeout(()=> {
      const wp = document.getElementById('welcomePopup');
      if(wp) wp.classList.add('visible');
    }, 60);

    // small focus styles for accessibility
    document.addEventListener('keydown', (e)=> {
      if(e.key === 'Escape') {
        // close overlays if open
        const adminModal = document.getElementById('adminModal');
        if(adminModal && adminModal.style.display === 'flex') closeAdminModal();
      }
    });

  </script>
</body>
</html>
```
